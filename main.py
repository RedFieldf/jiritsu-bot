import os
import tweepy
import google.generativeai as genai
import random
import requests
import io

# ---------------------------------------------------------
# 1. ç’°å¢ƒå¤‰æ•°
# ---------------------------------------------------------
GEMINI_API_KEY = os.environ.get("GEMINI_API_KEY")
X_API_KEY = os.environ.get("X_API_KEY")
X_API_SECRET = os.environ.get("X_API_SECRET")
X_ACCESS_TOKEN = os.environ.get("X_ACCESS_TOKEN")
X_ACCESS_TOKEN_SECRET = os.environ.get("X_ACCESS_TOKEN_SECRET")

# ---------------------------------------------------------
# 2. ã‚¬ãƒãƒ£ç”¨ãƒ‡ãƒ¼ã‚¿
# ---------------------------------------------------------
INDUSTRIES = [
    "é£Ÿå“ãƒ»è¾²æ—ãƒ»æ°´ç”£", "å»ºè¨­ãƒ»ä½å®…ãƒ»ã‚¤ãƒ³ãƒ†ãƒªã‚¢", "ç¹Šç¶­ãƒ»åŒ–å­¦ãƒ»è–¬å“ãƒ»åŒ–ç²§å“",
    "é‰„é‹¼ãƒ»é‡‘å±ãƒ»é‰±æ¥­", "æ©Ÿæ¢°ãƒ»ãƒ—ãƒ©ãƒ³ãƒˆ", "é›»å­ãƒ»é›»æ°—æ©Ÿå™¨",
    "è‡ªå‹•è»Šãƒ»è¼¸é€ç”¨æ©Ÿå™¨", "ç²¾å¯†ãƒ»åŒ»ç™‚æ©Ÿå™¨", "å°åˆ·ãƒ»äº‹å‹™æ©Ÿå™¨é–¢é€£", "ã‚¹ãƒãƒ¼ãƒ„ãƒ»ç©å…·",
    "ç·åˆå•†ç¤¾", "å°‚é–€å•†ç¤¾",
    "ç™¾è²¨åº—ãƒ»ã‚¹ãƒ¼ãƒ‘ãƒ¼", "ã‚³ãƒ³ãƒ“ãƒ‹", "å°‚é–€åº—",
    "éŠ€è¡Œãƒ»è¨¼åˆ¸", "ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆãƒ»ä¿¡è²©ãƒ»ãƒªãƒ¼ã‚¹", "ç”Ÿä¿ãƒ»æä¿",
    "ä¸å‹•ç”£", "é‰„é“ãƒ»èˆªç©ºãƒ»é‹è¼¸ãƒ»ç‰©æµ", "é›»åŠ›ãƒ»ã‚¬ã‚¹ãƒ»ã‚¨ãƒãƒ«ã‚®ãƒ¼",
    "ãƒ•ãƒ¼ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹", "ãƒ›ãƒ†ãƒ«ãƒ»æ—…è¡Œ", "åŒ»ç™‚ãƒ»ç¦ç¥‰",
    "ã‚¢ãƒŸãƒ¥ãƒ¼ã‚ºãƒ¡ãƒ³ãƒˆãƒ»ãƒ¬ã‚¸ãƒ£ãƒ¼", "ã‚³ãƒ³ã‚µãƒ«ãƒ†ã‚£ãƒ³ã‚°ãƒ»èª¿æŸ»", "äººæã‚µãƒ¼ãƒ“ã‚¹", "æ•™è‚²",
    "ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢", "ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ", "é€šä¿¡",
    "æ”¾é€", "æ–°è", "å‡ºç‰ˆ", "åºƒå‘Š",
    "å®˜å…¬åº", "å…¬ç¤¾ãƒ»å›£ä½“"
]

TOPICS = [
    "äº‹æ¥­å†…å®¹ï¼ˆãƒ“ã‚¸ãƒã‚¹ãƒ¢ãƒ‡ãƒ«ã®ã€åç›Šæºã€ã‚’é‹­ãè§£èª¬ï¼‰",
    "æœ€æ–°ã®æ¥­ç•Œå‹•å‘ï¼ˆæ—¥çµŒæ–°èãƒ¬ãƒ™ãƒ«ã®ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ»å°†æ¥æ€§ï¼‰",
    "ä»•äº‹å†…å®¹ãƒ»è·ç¨®ï¼ˆç¾å ´ã®ãƒªã‚¢ãƒ«ã¨æ±‚ã‚ã‚‰ã‚Œã‚‹èƒ½åŠ›ï¼‰",
    "é­…åŠ›ãƒ»ã‚„ã‚ŠãŒã„ï¼ˆå¸‚å ´ä¾¡å€¤ã‚„ã‚­ãƒ£ãƒªã‚¢ã®åºƒãŒã‚Šï¼‰"
]

# ---------------------------------------------------------
# 3. Geminiã®è¨­å®š
# ---------------------------------------------------------
genai.configure(api_key=GEMINI_API_KEY)
model = genai.GenerativeModel("gemini-2.5-flash")

# ---------------------------------------------------------
# 4. ãƒ„ã‚¤ãƒ¼ãƒˆæœ¬æ–‡ã‚’ä½œã‚‹é–¢æ•°
# ---------------------------------------------------------
def generate_tweet_text(industry, topic):
    prompt = f"""
    ã‚ãªãŸã¯ã€Œæˆ¦ç•¥çš„ã‚­ãƒ£ãƒªã‚¢ã‚³ãƒ¼ãƒï¼ˆã‚¸ãƒªãƒ„é‹å–¶ï¼‰ã€ã§ã™ã€‚
    ã€å¯¾è±¡æ¥­ç•Œã€‘{industry} ã® ã€ãƒ†ãƒ¼ãƒã€‘{topic} ã«ã¤ã„ã¦ã€
    å°±æ´»ç”Ÿï¼ˆ26å’ãƒ»27å’ãƒ»28å’ï¼‰ã«å‘ã‘ãŸæœ‰ç›Šãªãƒ„ã‚¤ãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

    ã€ãƒ«ãƒ¼ãƒ«ã€‘
    - çŸ¥çš„ã§è«–ç†çš„ãªã€Œè¨€ã„åˆ‡ã‚Šã€ã¾ãŸã¯ã€Œã§ã™ãƒ»ã¾ã™ã€èª¿ã€‚
    - ãƒ“ã‚¸ãƒã‚¹ã®æœ¬è³ªã‚„è£å´ã®é¢ç™½ã•ã‚’èªã‚‹ã€‚
    - æœ€å¾Œã« #å°±æ´» #26å’ #27å’ #28å’ ã‚’ã¤ã‘ã‚‹ã€‚
    - æ–‡å­—æ•°ã¯ã‚¿ã‚°è¾¼ã¿135æ–‡å­—ä»¥å†…ã€‚
    """
    response = model.generate_content(prompt)
    return response.text.strip()

# ---------------------------------------------------------
# 5. ç”»åƒç”Ÿæˆç”¨ã®ã€Œè‹±èªã®æŒ‡ç¤ºã€ã‚’ä½œã‚‹é–¢æ•°
# ---------------------------------------------------------
def generate_image_prompt(industry, tweet_text):
    prompt = f"""
    ä»¥ä¸‹ã®ãƒ„ã‚¤ãƒ¼ãƒˆå†…å®¹ã‚’è£œå®Œã™ã‚‹ã€æŠ½è±¡çš„ã§ã‚¯ãƒ¼ãƒ«ãªãƒ“ã‚¸ãƒã‚¹ç”»åƒã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆæŒ‡ç¤ºæ–‡ï¼‰ã‚’è‹±èªã§ä½œæˆã—ã¦ãã ã•ã„ã€‚

    ã€ãƒ„ã‚¤ãƒ¼ãƒˆå†…å®¹ã€‘
    {tweet_text}

    ã€æ¥­ç•Œã€‘
    {industry}

    ã€åˆ¶ç´„ã€‘
    - è‹±èªã§å‡ºåŠ›ã™ã‚‹ã“ã¨ã€‚
    - "A high quality illustration of..." ã‹ã‚‰å§‹ã‚ã‚‹ã€‚
    - äººç‰©ã¯ã‚·ãƒ«ã‚¨ãƒƒãƒˆã‚„å¾Œã‚å§¿ãªã©ã€æŠ½è±¡çš„ã«ã™ã‚‹ï¼ˆé¡”ã®å´©ã‚Œã‚’é˜²ããŸã‚ï¼‰ã€‚
    - ãƒ“ã‚¸ãƒã‚¹ã€æœªæ¥çš„ã€æ´—ç·´ã•ã‚ŒãŸã€ã‚µã‚¤ãƒãƒ¼ãƒ‘ãƒ³ã‚¯ã€ãƒŸãƒ‹ãƒãƒªã‚ºãƒ ãªã©ã®è¦ç´ ã‚’å…¥ã‚Œã‚‹ã€‚
    - å‡ºåŠ›ã¯ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è‹±æ–‡ã®ã¿ã«ã™ã‚‹ã€‚
    """
    response = model.generate_content(prompt)
    return response.text.strip()

# ---------------------------------------------------------
# 6. ç”»åƒã‚’ç”Ÿæˆã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹é–¢æ•°ï¼ˆPollinationsä½¿ç”¨ï¼‰
# ---------------------------------------------------------
def generate_and_download_image(image_prompt):
    # Pollinations.aiã¨ã„ã†ç„¡æ–™APIã‚’ä½¿ã„ã¾ã™ï¼ˆç™»éŒ²ä¸è¦ï¼‰
    # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’URLã«åŸ‹ã‚è¾¼ã‚€ã ã‘ã§ç”»åƒãŒç”Ÿæˆã•ã‚Œã¾ã™
    base_url = "https://image.pollinations.ai/prompt/"
    # æ—¥æœ¬èªãªã©ãŒæ··ã˜ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã®ã§URLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ç­‰ã¯requestsãŒã‚„ã£ã¦ãã‚Œã¾ã™ãŒã€å¿µã®ãŸã‚ã‚·ãƒ³ãƒ—ãƒ«ã«
    seed = random.randint(0, 10000) # æ¯å›é•ã†ç”»åƒã«ã™ã‚‹
    
    # URLã‚’ä½œæˆ (widthã¨heightã‚’æŒ‡å®š)
    url = f"{base_url}{image_prompt}?width=1080&height=1080&seed={seed}&nologo=true&model=flux"
    
    print(f"ç”»åƒç”Ÿæˆä¸­...: {url}")
    response = requests.get(url)
    
    if response.status_code == 200:
        return io.BytesIO(response.content) # ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¡ãƒ¢ãƒªä¸Šã«ä¿å­˜
    else:
        print("ç”»åƒç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ")
        return None

# ---------------------------------------------------------
# 7. Xã«æŠ•ç¨¿ã™ã‚‹ï¼ˆç”»åƒæ·»ä»˜ã‚ã‚Šï¼‰
# ---------------------------------------------------------
def post_with_image(text, image_data):
    # API v1.1 (ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨)
    auth = tweepy.OAuth1UserHandler(
        X_API_KEY, X_API_SECRET, X_ACCESS_TOKEN, X_ACCESS_TOKEN_SECRET
    )
    api = tweepy.API(auth)

    # API v2 (ãƒ„ã‚¤ãƒ¼ãƒˆæŠ•ç¨¿ç”¨)
    client = tweepy.Client(
        consumer_key=X_API_KEY,
        consumer_secret=X_API_SECRET,
        access_token=X_ACCESS_TOKEN,
        access_token_secret=X_ACCESS_TOKEN_SECRET
    )

    # å›ºå®šãƒªãƒ—ãƒ©ã‚¤
    reply_text = """
    æˆ‘ã€…ã‚¸ãƒªãƒ„ã¯ç´å¾—å†…å®šç²å¾—ã«å‘ã‘ãŸã”æ”¯æ´ã‚’ã—ã¦ãŠã‚Šã¾ã™ã€‚
    ç„¡æ–™ç›¸è«‡ã¯ã“ã¡ã‚‰ã‹ã‚‰ğŸ‘‡
    https://www.jicoo.com/t/dX0f4ah7ZNbn/e/jiritsu?utm_source=opencaht
    """

    try:
        media_id = None
        if image_data:
            # 1. ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (v1.1ã‚’ä½¿ç”¨)
            media = api.media_upload(filename="image.jpg", file=image_data)
            media_id = media.media_id
            print("ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸ")

        # 2. ãƒ„ã‚¤ãƒ¼ãƒˆæŠ•ç¨¿ (ç”»åƒIDã‚’ç´ä»˜ã‘)
        if media_id:
            response = client.create_tweet(text=text, media_ids=[media_id])
        else:
            response = client.create_tweet(text=text) # ç”»åƒãªã—ã®å ´åˆ
            
        tweet_id = response.data['id']
        print(f"ãƒ¡ã‚¤ãƒ³æŠ•ç¨¿æˆåŠŸï¼ ID: {tweet_id}")

        # 3. å®£ä¼ãƒªãƒ—ãƒ©ã‚¤
        client.create_tweet(text=reply_text.strip(), in_reply_to_tweet_id=tweet_id)
        print("å®£ä¼ãƒªãƒ—ãƒ©ã‚¤æˆåŠŸï¼")

    except Exception as e:
        print(f"æŠ•ç¨¿ã‚¨ãƒ©ãƒ¼: {e}")

# ---------------------------------------------------------
# ãƒ¡ã‚¤ãƒ³å‡¦ç†
# ---------------------------------------------------------
if __name__ == "__main__":
    print("---å‡¦ç†é–‹å§‹---")
    try:
        # 1. ãƒã‚¿æ±ºã‚
        industry = random.choice(INDUSTRIES)
        topic = random.choice(TOPICS)
        print(f"ä»Šæ—¥ã®ãƒ†ãƒ¼ãƒ: {industry} Ã— {topic}")

        # 2. ãƒ„ã‚¤ãƒ¼ãƒˆæ–‡ç« ç”Ÿæˆ
        tweet_text = generate_tweet_text(industry, topic)
        print("ãƒ„ã‚¤ãƒ¼ãƒˆç”Ÿæˆå®Œäº†")

        # 3. ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ
        img_prompt = generate_image_prompt(industry, tweet_text)
        print(f"ç”»åƒæŒ‡ç¤º: {img_prompt}")

        # 4. ç”»åƒç”Ÿæˆ (ç„¡æ–™API)
        image_data = generate_and_download_image(img_prompt)

        # 5. æŠ•ç¨¿
        post_with_image(tweet_text, image_data)

    except Exception as e:
        print(f"äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼: {e}")
    print("---å‡¦ç†çµ‚äº†---")
